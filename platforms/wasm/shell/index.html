<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Demo Wasm</title>

    <link href="style.css" rel="stylesheet"/>

    @SHELL_HR_SCRIPT@

    <script src="scripts/load_wasm.js" type="application/javascript"></script>
</head>
<body>
<main>
    <div class="canvas-container">
        <canvas height="@BUFFER_HEIGHT@" id="canvas" width="@BUFFER_WIDTH@">
        </canvas>
        <div class="canvas-overlay">
        </div>
    </div>
    <div class="controls">
        <div class="progress">
            <input id="seekbar" min="0" step="1" type="range" />
        </div>
        <button id="playpause" onclick="onPlayPause()">pause</button>
        <button onclick="fullscreen()">fullscreen</button>
    </div>
</main>

<script>

    const canvas = document.getElementById("canvas")
    const seekbar = document.getElementById("seekbar")

    let max_time = 0;

    let canvasWasPlayingBeforeSeeking = false

    init_wasm(canvas,
        @BUFFER_WIDTH@, @BUFFER_HEIGHT@,
        @INITIAL_MEMORY_PAGES@, @MAX_MEMORY_PAGES@
    )

    function onPlayPause() {
        canvas.playPause()
    }

    function fullscreen() {
        const container = document.querySelector(".canvas-container")
        container.requestFullscreen()
    }

    canvas.addEventListener('play', () => {
        document.getElementById('playpause').innerHTML = canvas.isPlaying() ? "Pause" : "Play"
    })

    canvas.addEventListener('pause', () => {
        document.getElementById('playpause').innerHTML = canvas.isPlaying() ? "Pause" : "Play"
    })

    canvas.addEventListener('frame', (e) => {
        const { time } = e.detail

        max_time = Math.max(time || 0, max_time)
        seekbar.max = max_time
        seekbar.min = 0

        seekbar.value = time
    })


    seekbar.addEventListener('pointerdown', () => {
        canvasWasPlayingBeforeSeeking = canvas.isPlaying()
        canvas.pause()
    })

    seekbar.addEventListener('pointerup', () => {
        if (canvasWasPlayingBeforeSeeking)
            canvas.play()
    })

    seekbar.addEventListener('input', (e) => {
        canvas.seek(parseInt(seekbar.value))
    })

</script>


</body>
</html>